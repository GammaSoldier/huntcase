<?php


/***************************************************************************************************
***************************************************************************************************/
function ShowLists() 
{
	global $Output;
	
	FormLocation( 'enternewlocation', '', '', '', 0 );
	$Output .= '<br>';
	$Output .= '<br>';
	ListLocations();
	$Output .= '<br>';
	$Output .= '<br>';
	ListDates( false );
	$Output .= '<br>';
	$Output .= '<br>';
	ListDates( true );
}// NewLocation



/***************************************************************************************************
***************************************************************************************************/
function DeleteDate()
{
	global $Output;

	if( DBOpen( $Link ) ) {
		$Result = mysql_query( "DELETE FROM ".TAB_DATES." WHERE ID='".$_REQUEST['dateid']."'" );
		DBClose( $Link );
	}// if
	else {
		$Output .= 'Could not access DB';
	}// else

}// DeleteDate

/***************************************************************************************************
***************************************************************************************************/
function CancelDate()
{
	global $Output;


	if( DBOpen( $Link ) ) {
		$Result = mysql_query( "SELECT * FROM ".TAB_DATES." WHERE ID='".$_REQUEST['dateid']."'" );
		if( $Result ) {
			$Row = mysql_fetch_array( $Result );
			
			var_dump( $Row );
		}// if
		
		DBClose( $Link );
	}// if
	else {
		$Output .= 'Could not access DB';
	}// else

}// CancelDate



/***************************************************************************************************
***************************************************************************************************/
function ConfirmDateDeletion()
{
	global $Output;

	$Output .= '<span style="color: #ff0000; font-weight: bold; font-size: 2em;">WARNING!</span><br><br>';
	$Output .= 'Are you sure you want to delete this date? <br><br>';

	if( DBOpen( $Link ) ) {
		$result = mysql_query( "SELECT * FROM ".TAB_DATES." WHERE id=".$_REQUEST['date'] );
		$RowTime = mysql_fetch_array( $result );

		$result2 = mysql_query( "SELECT * FROM ".TAB_LOCATIONS." WHERE ID=".$RowTime['location'] );
		$RowLocation = mysql_fetch_array( $result2 );

		if( !isset($RowLocation['name']) ) {
			$RowLocation['name'] = 'Location deleted';
		}// else

		$Output .= strftime("%d", $RowTime['timestamp'] ).". ";
		$Output .= strftime("%m", $RowTime['timestamp'] ).". ";
		$Output .= strftime("%Y", $RowTime['timestamp'] );
		$Output .= '<br>'.$RowLocation['name'].' '.$RowLocation['address'].'<br><br>';

		$Output .= '<form method="post" action="'.$_SERVER['PHP_SELF'].'?action=deldate">';
		$Output .= '<table><tr>';
		
		$Output .= '<td><input type="hidden" name="dateid" value="'.$_REQUEST['date'].'" />';
		$Output .= '<input type="submit" name="btnsend" value="Keep" style="height: 20px; width: 100px"/></td>';
		$Output .= '<td><input type="submit" name="btnsend" value="Delete" style="height: 20px; width: 100px"/></td>';
//		$Output .= '<td><input type="submit" name="btnsend" value="Cancel" style="height: 20px; width: 100px"/></td>';
		$Output .= '</tr>';
		$Output .= '<tr>';
		$Output .= '<td>Don\'t delete date</td>';
		$Output .= '<td>Delete date</td>';
//		$Output .= '<td>Delete date and inform users</td>';
		$Output .= '</tr>';
		
		$Output .= '</form>';
		DBClose( $Link );
	}// if
	else {
		$Output .= 'Could not access DB';
	}// else
}// ConfirmDateDeletion


/***************************************************************************************************
***************************************************************************************************/
function NewDate()
{
	global $Output;
	$RetVal = false;
	
	$Timestamp = mktime( $_REQUEST['hour']
						,$_REQUEST['minute']
						,0
						,$_REQUEST['month']
						,$_REQUEST['day']
						,$_REQUEST['year']
						);
	
	// date in the past
	if( $Timestamp < time() ) {
		$Output .= 'This date is already in the past. Try one in the future.';
	}//if
	else {
		if( DBOpen( $Link ) ) {
			DBDo( "INSERT INTO ".TAB_DATES." (timestamp, location, cancelled ) VALUES ('".$Timestamp."', '".$_REQUEST['location']."', 0)" );
			DBClose( $Link );
		}// if
		else {
			$Output .= 'Could not access DB';
		}// else
		$RetVal = true;
	}// else
	
	return $RetVal;
}// NewDate



/***************************************************************************************************
***************************************************************************************************/
function EnterNewDate()
{
	global $Output;

	if( DBOpen( $Link ) ) {
		$Result = mysql_query( "SELECT * FROM ".TAB_LOCATIONS." WHERE ID='".$_REQUEST['location']."'" );
		if( $Result ) {
			$Row = mysql_fetch_array( $Result );
		}// if

		$Now = getdate(time());
		
		$Output .= '<table class="listing" align="center"><tr><th colspan="2">';
		$Output .= 'New Date: </th></tr>';
		$Output .= '<tr ><td colspan="2">';
		$Output .= 'Enter day and time for a gig in:<br><br>';
		$Output .= '</td></tr>';
		$Output .= '<tr class="odd"><td colspan="2">';
		$Output .= '<br>'.$Row['name'].'<br>'.$Row['address'].'<br><br>';
		$Output .= '</td></tr>';
		$Output .= '<tr ><td width="50%">';
		

		$Output .= '<form method="post" action="'.$_SERVER['PHP_SELF'].'?action=newdate">';
		$Output .= 'Day: ';
		$Output .= '<select size="1" name="day" style="width: 40px; text-align: right;">';
		for( $i=1; $i<=31; $i++ ) {
			$Output .= '<option';
			if( $i == $Now['mday'] ) {
				$Output .= ' selected';
			}// if
			$Output .= '>'.$i.'</option>';
		}// for $i
		$Output .= '</select>';
		
		$Output .= ' Month: ';
		$Output .= '<select size="1" name="month" style="width: 40px; text-align: right;">';
		for( $i=1; $i<=12; $i++ ) {
			$Output .= '<option';
			if( $i == $Now['mon'] ) {
				$Output .= ' selected';
			}// if
			$Output .= '>'.$i.'</option>';
		}// for $i
		$Output .= '</select>';

		$Output .= ' Year: ';
		$Output .= '<select size="1" name="year" style="width: 60px; text-align: right;">';
		for( $i=$Now['year']; $i <= $Now['year']+9; $i++ ) {
			$Output .= '<option';
			if( $i == $Now['year'] ) {
				$Output .= ' selected';
			}// if
			$Output .= '>'.$i.'</option>';
		}// for $i
		$Output .= '</select>';

		$Output .= '</td>';
		$Output .= '<td>';

		$Output .= ' Hour: ';
		$Output .= '<input type="text" name="hour" value="20" style="width: 40px;" />';
		$Output .= ' Minute: ';
		$Output .= '<input type="text" name="minute" value="00" style="width: 40px;" />';
		$Output .= '<input type="hidden" name="location" value="'.$_REQUEST['location'].'"/>';

		$Output .= '</td></tr>';
		$Output .= '<tr><td colspan="2" align="center">';
		$Output .= '<br><input type="submit" name="btnsend" value="Submit" style="height: 20px; width: 100px"/>';
		$Output .= '</form>';

		$Output .= ' </td></tr></table>';	
		DBClose( $Link );
	}// if
	else {
		$Output .= 'Could not access DB';
	}// else

	
}// EnterNewDate



/***************************************************************************************************
***************************************************************************************************/
function DeleteLocationConfirm() 
{
	global $Output;

	$Output .= '<span style="color: #ff0000; font-weight: bold; font-size: 2em;">WARNING!</span><br><br>';
	$Output .= 'Are you sure you want to delete this location? <br>
			No more backtracking of dates to this location will be possible.<br><br>';
	
	$Output .= '<form method="post" action="'.$_SERVER['PHP_SELF'].'?action=confirmlocationdeletion">';
	$Output .= '<input type="hidden" name="locationid" value="'.$_REQUEST['locationid'].'" />';
	$Output .= '<input type="submit" name="btnsend" value="Keep" style="height: 20px; width: 100px"/>';
	$Output .= '<input type="submit" name="btnsend" value="Delete" style="height: 20px; width: 100px"/>';
	$Output .= '</form>';
	
}// DeleteLocationConfirm


/***************************************************************************************************
***************************************************************************************************/
function DeleteLocation()
{
	global $Output;

	if( DBOpen( $Link ) ) {
		$Result = mysql_query( "DELETE FROM ".TAB_LOCATIONS." WHERE ID='".$_REQUEST['locationid']."'" );
		DBClose( $Link );
	}// if
	else {
		$Output .= 'Could not access DB';
	}// else
}// DeleteLocation



/***************************************************************************************************
***************************************************************************************************/
function EditLocation()
{
	global $Output;

	if( DBOpen( $Link ) ) {
		$Result = mysql_query( "SELECT * FROM ".TAB_LOCATIONS." WHERE ID='".$_REQUEST['location']."'" );
		if( $Result ) {
			$Row = mysql_fetch_array( $Result );
			FormLocation( 'modifylocation', $Row['name'], $Row['address'], $Row['remarks'], $_REQUEST['location'] );
		}// if
		DBClose( $Link );
	}// if
	else {
		$Output .= 'Could not access DB';
	}// else
}// EditLocation


/***************************************************************************************************
***************************************************************************************************/
function ModifyLocation() 
{
	global $Output;

	$Output .= '<br>';
	if( DBOpen( $Link ) ) {
		$Query = "UPDATE ".TAB_LOCATIONS." SET name='"
				.mysql_escape_string($_REQUEST['locationname'])
				."', address='"
				.mysql_escape_string($_REQUEST['locationaddress'])
				."', remarks='"
				.mysql_escape_string($_REQUEST['locationremarks'])
				."' WHERE id="
				.$_REQUEST['locationid'];
				
		DBDo( $Query );
		DBClose( $Link );
	}// if
	else {
		$Output .= 'Could not access DB';
	}// else
	
}// ModifyLocation



/***************************************************************************************************
***************************************************************************************************/
function NewLocation() 
{
	global $Output;

	if( DBOpen( $Link ) ) {
		DBDo( "INSERT INTO ".TAB_LOCATIONS." (name, address, remarks) VALUES ('"
				.mysql_escape_string($_REQUEST['locationname'])
				."', '"
				.mysql_escape_string($_REQUEST['locationaddress'])
				."', '"
				.mysql_escape_string($_REQUEST['locationremarks'])
				."')" );
		DBClose( $Link );
	}// if
	else {
		$Output .= 'Could not access DB';
	}// else
	
}// NewLocation


/***************************************************************************************************
***************************************************************************************************/
function CheckNewLocation()
{
	global $Output;
	$RetVal = false;
	if( DBOpen( $Link ) ) {
		$Result = mysql_query( "SELECT * FROM ".TAB_LOCATIONS." WHERE name='".$_REQUEST['locationname']."'" );
		DBClose( $Link );

		if( $Result ) {
			$Row = mysql_fetch_array( $Result );
			if( $Row['name'] == $_REQUEST['locationname'] ) {
				$Output .= '<span style="color: #ff0000; font-weight: bold;">Location name already exists as:</span><br><br>';
				$Output .= $Row['name'].'<br>'.$Row['address'].'<br>'.$Row['remarks'].'<br><br><br><br>';
				$Output .= 'You entered<br><br>';
				$Output .= $_REQUEST['locationname'].'<br>'.$_REQUEST['locationaddress'].'<br>'.$_REQUEST['locationremarks'].'<br><br><br><br>';
				
				$Output .= 'Add location anyway?<br><br>';
				$Output .= '<form method="post" action="'.$_SERVER['PHP_SELF'].'?action=confirmnewlocation">';
				$Output .= '<input type="hidden" name="locationname" value="'.$_REQUEST['locationname'].'" />';
				$Output .= '<input type="hidden" name="locationaddress" value="'.$_REQUEST['locationaddress'].'" />';
				$Output .= '<input type="hidden" name="locationremarks" value="'.$_REQUEST['locationremarks'].'" />';
				$Output .= '<input type="submit" name="btnsend" value="Yes" style="height: 20px; width: 100px"/>&nbsp;';
				$Output .= '<input type="submit" name="btnsend" value="No" style="height: 20px; width: 100px"/>';
				$Output .= '</form>';
			}// if
			else {
				NewLocation();
				$RetVal = true;
			}// else
		}
		else {
			NewLocation();
			$RetVal = true;
		}// else
			
	}// if
	else {
		$Output .= 'Could not access DB';
	}// else
	return $RetVal;
}// CheckNewLocation

/***************************************************************************************************
***************************************************************************************************/
function FormLocation( $Action, $Name, $Address, $Remarks, $ID )
{
	global $Output;

	$Output .= '<table class="listing" align="center"><tr><th colspan="2">';
	if( $Action == 'enternewlocation' ) {
		$Output .= 'New Location: </th></tr>';
	}// if
	else {
		$Output .= 'Location: </th></tr>';
	}// esle
	
	$Output .= '	<form method="post" action="'.$_SERVER['PHP_SELF'].'?action='.$Action.'">';
	$Output .= '	<tr><td width="80em">';
	$Output .= '	<b>Name:</b></td><td><input type="text" name="locationname" value="'.$Name.'" maxlength="255" style="width: 100%;"/>';
	$Output .= '	</tr></td>';
	$Output .= '	<tr><td>';
	$Output .= '	<b>Address:</b></td><td><input type="text" name="locationaddress"  value="'.$Address.'" maxlength="255" style="width: 100%;"/>';
	$Output .= '	</tr></td>';
	$Output .= '	<tr><td>';
	$Output .= '	<b>Remarks:</b></td><td><textarea name="locationremarks" rows="3" style="width: 100%;">'.$Remarks.'</textarea>';
	$Output .= '	</tr></td>';
	$Output .= '	<input type="hidden" name="locationid" value="'.$ID.'" />';
	$Output .= '	<tr><td>';
	$Output .= '	</td><td><input type="submit" name="btnsend" value="Submit" style="width: 100px;"/>';

	if( $Action != 'enternewlocation' ) {
		$Output .= ' <input type="submit" name="btnsend" value="Delete" style="width: 100px;"/>';
	}// if
			
	$Output .= '	</form>';

	$Output .= ' </td></tr></table>';	
}// FormLocation




/***************************************************************************************************
***************************************************************************************************/
function ListLocations() 
{
	global $Output;

	if( DBOpen( $Link ) ) {
		
		$Output .= '<table class="listing" align="center"><tr><th colspan="4">';
		$Output .= 'Locations: </th></tr>';

		$Result = mysql_query( "SELECT * FROM ".TAB_LOCATIONS." ORDER BY name ASC" );

		$ColorCounter = 0;
		while( $Row = mysql_fetch_array( $Result )) {
			if( $ColorCounter ) {
				$Output .= '<tr class="odd"><td>';
			}// if
			else{
				$Output .= '<tr class="even"><td>';
			}// else
			
			$Remarks = htmlentities( mysql_escape_string( $Row['remarks'] ) );
			$Remarks = str_replace ('\n', '<br>', $Remarks);
			$Remarks = str_replace ('\r', '', $Remarks);

			
			$Output .= '<a href="'.$_SERVER['PHP_SELF'].'?action=enternewdate&location='.$Row['id'].'">new date</a></td>';
			$Output .= '<td width="40%">'.$Row['name'].'</td>';
			$Output .= '<td>'.$Row['address'].'<br><span style="color: #ff0000">'.$Remarks.'</span></td>';
			$Output .= '<td><a href="'.$_SERVER['PHP_SELF'].'?action=editlocation&location='.$Row['id'].'">edit</a></td></tr>';		
			$ColorCounter = 1 - $ColorCounter;
		}// while
		$Output .= '</table>';
		
		DBClose( $Link );
	}// if
	else {
		$Output .= 'Could not access DB';
	}// else
}// ListLocations



/***************************************************************************************************
***************************************************************************************************/
function ListDates( $Past )
{
	global $Output;

	if( DBOpen( $Link ) ) {
		$Output .= '<table class="listing" align="center"><tr><th colspan="4">';
		if( $Past ) {
			$Output .= 'Past Dates: </th></tr>';
		}// if
		else {
			$Output .= 'Next Dates: </th></tr>';
		}// else

		$Now = time();
		
		$ColorCounter = 0;
		$DateCounter = 0;
		
		$LocalOutput = '';
		$result = mysql_query( "SELECT * FROM ".TAB_DATES." ORDER BY timestamp ASC" );
		while( $RowTime = mysql_fetch_array( $result ) ) {
			$DateCounter++;
			$result2 = mysql_query( "SELECT * FROM ".TAB_LOCATIONS." WHERE ID=".$RowTime['location'] );
			$RowLocation = mysql_fetch_array( $result2 );
			
			// location id doesn't exist, may have been deleted
			if( !isset($RowLocation['name']) ) {
				$RowLocation['name'] = 'Location deleted';
			}// else
			
			// toggle background color per table row
			if( $ColorCounter ) {
				$LocalOutput .= '<tr class="odd"><td width="7%">';
			}// if
			else{
				$LocalOutput .= '<tr class="even"><td width="7%">';
			}// else

			// set color and deletion link for dates in future
			$TextClass = '';
			if( $RowTime['timestamp'] >= $Now ) {
				$LocalOutput .= '<a href="'.$_SERVER['PHP_SELF'].'?action=confirmdatedeletion&date='.$RowTime['id'].'">delete</a></td>';
				$TextClass = 'class="Future"';

			}// if
			else{
				$LocalOutput .= $DateCounter;
			}// else
			$LocalOutput .= '<td width="13%" '.$TextClass.'>';
			
			$LocalOutput .= strftime("%d", $RowTime['timestamp'] ).". ";
			$LocalOutput .= strftime("%m", $RowTime['timestamp'] ).". ";
			$LocalOutput .= strftime("%Y", $RowTime['timestamp'] );

			$LocalOutput .= '</td>';
			$LocalOutput .= '<td width="40%" '.$TextClass.'>'.$RowLocation['name'].'</td>';
			$LocalOutput .= '<td width="40%" '.$TextClass.'>'.$RowLocation['address'].'</td>';
			$LocalOutput .= '</tr>';	
	
			if( $Past == true ) {
				if( ($RowTime['timestamp'] < $Now) && ($RowTime['cancelled'] == 0)) {
					$Output .= $LocalOutput;
				}// if
			}// if
			else {
				if( $RowTime['timestamp'] >= $Now ) {
					$Output .= $LocalOutput;
				}// if
			}// else
			$LocalOutput = '';
			$ColorCounter = 1 - $ColorCounter;
		}// while
		$Output .= '</table>';
		DBClose( $Link );
	}// if
	else {
		$Output .= 'Could not access DB';
	}// else
}// ListDates 

?>