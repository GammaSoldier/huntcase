<?php

include_once 'database.php';
include 'notify.php';
include 'ctracker.php';
include_once 'templates.php';


$NotifyFlag = false;
$Output = '';	

if( isset( $_REQUEST[ 'email' ] ) ) {
	$EMail = $_REQUEST[ 'email' ];

	// check for exactly one '@' and '.' like 'joe@here.net'
	if( !preg_match( "/^[^@]+@[^@]+\..+$/", $EMail ) ) {
		$Output	= GetTemplate( 'templates/reguser_invalid.htm' );
	}// if 
	else {
		$Hash = md5( $EMail );
		if( DBOpen( $Link ) ) {
			$Result = mysql_query( "SELECT * FROM ".TAB_USERS." WHERE hash='".$Hash."'" );
			$Row = mysql_fetch_array( $Result );

			if( !$Row ) {
				DBDo( "INSERT INTO ".TAB_USERS." (email, hash, notified ) VALUES ('".$EMail."', '".$Hash."', '0')" );
				
				// do query to get the id for the call to NotifyUser
				$Result = mysql_query( "SELECT * FROM ".TAB_USERS." WHERE hash='".$Hash."'" );
				$Row = mysql_fetch_array( $Result );
				$NotifyFlag = true;

				$Output	= GetTemplate( 'templates/reguser_acknowledge.htm' );
			}// if
			else {
				$Output	= GetTemplate( 'templates/reguser_not_acknowledge.htm' );
			}// else

			DBClose( $Link );

			if( $NotifyFlag ) {
				NotifyUser( $Row['id'], $Row['email'], $Row['hash'], $Row['notified'] );
			}// if
		}// if
		else {
			$Output = 'Could not access DB';
		}// else
	}// else
}// if


$Content = array( 'OUTPUT' => $Output );
$Content = array( 'CONTENT' => ParseTemplate( 'templates/reguser.htm', $Content ) );
$Output = ParseTemplate( 'templates/site.htm', $Content );

echo $Output;
?>

