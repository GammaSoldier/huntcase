<?php

define ('DAYS_IN_ADVANCE', 5 );

include_once 'config.php';
include_once 'database.php';
include_once 'templates.php';

$MailOriginator = MAIL_ADDRESS;

$MailSubject = BAND_NAME.' Infomail';



/***************************************************************************************************
***************************************************************************************************/
function NotifyUser( $UserID, $EMail, $Hash, $Notified )
{
	global $MailOriginator;
	global $MailSubject;
	
	$Header  = 'MIME-Version: 1.0'."\r\n";
	$Header .= 'Content-type: text/html; charset=iso-8859-1' . "\r\n";				
	$Header .= 'From: '.$MailOriginator."\r\n";
	$Header .= 'Reply-To: '.$MailOriginator."\r\n";
	
	$Now = time();
	$TimeDiff = DAYS_IN_ADVANCE * 24 * 3600; // Seven days given in seconds
	$NotifyFlag = false;

	$WDays = array("So", "Mo", "Di", "Mi", "Do", "Fr", "Sa" );
	$Months = array( "Januar", "Februar", "März", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember" );
	
	$Date = '';
	
	if( DBOpen( $Link ) ) {
		$Result = mysql_query( "SELECT * FROM ".TAB_DATES );
		while( $RowTime = mysql_fetch_array( $Result ) ) {
			if(  $RowTime['timestamp'] > $Now ) {
				if(( $RowTime['timestamp'] - $Now ) < $TimeDiff ) {
					if(( $RowTime['timestamp'] - $Notified ) >= $TimeDiff ) {
						// Notify user
						$Result2 = mysql_query( "SELECT * FROM ".TAB_LOCATIONS." WHERE ID=".$RowTime['location'] );
						$RowLocation = mysql_fetch_array( $Result2 );

						$GoogleLink = str_replace( ' ', '+', $RowLocation['address'] );

						$Content = array( 
							 'WEEKDAY' => $WDays[ strftime("%w", $RowTime['timestamp'] ) ]
							,'DAY' => strftime("%d", $RowTime['timestamp'] )				
							,'MONTH' => $Months[ strftime("%m", $RowTime['timestamp'] ) - 1 ]				
							,'YEAR' => strftime("%Y", $RowTime['timestamp'] )				
							,'TIME' => 	strftime("%H:%M", $RowTime['timestamp'] )			
							,'LOCATION' => $RowLocation['name']				
							,'ADDRESS' => $RowLocation['address']				
							,'GOOGLELINK' => $GoogleLink				
						);
						$Date .= ParseTemplate( 'templates/notification_date.htm', $Content );

						$NotifyFlag = true;
					}// if
					else {
					}// else
				}// if
			}// if
		}// while

		$Content = array( 
			 'DATE' => $Date
			,'HASH' => $Hash				
		);
		$Output = ParseTemplate( 'templates/notification.htm', $Content );

		if( $NotifyFlag ) {
			mail( $EMail, $MailSubject, $Output, $Header, '-f'.$MailOriginator );
			mysql_query( "UPDATE ".TAB_USERS." SET notified=".$Now." WHERE id=".$UserID );
		}// if
		DBClose( $Link );
	}// if
	else {
	}// else
}

?>